
; ******** Source: 64keymaps.asm
     1                          ; 64keymaps.asm
     2                          ;
     3                          ; Copyright (c) 2025 by David R. Van Wagner
     4                          ; MIT LICENSE
     5                          ; github.com/davervw
     6                          ;
     7                          ; keyboard map editor for Commodore 64
     8                          ; allows remapping of keyboard on standard hardware
     9                          ; such as for internationalization for different regions
    10                          ; or modernization (more closely match modern keyboard layouts)
    11                          ;
    12                          ; currently displays keyboard maps, port of BASIC code to 6502
    13                          
    14                          chrout = $ffd2
    15                          getkey = $ffe4
    16                          
    17                          jiffyclock = $a2
    18                          textptr = $d1 ;/d2 - pointer to current logical screen line, leftmost column
    19                          colorptr = $f3 ;/f4 - matching pointer to color memory
    20                          
    21                          reverse = $c7
    22                          physline = $d6
    23                          logcol = $d3
    24                          quote = $d4
    25                          inserts = $d8
    26                          color = 646
    27                          screenpage = 648
    28                          shiftstate = $28d
    29                          remaps_dest = $08fc
    30                          border = $d020
    31                          background = $d021
    32                          
    33                          * = $c000
    34                          
    35                          start:
    36  c000 4c06c0                 jmp init
    37  c003 4c37c1                 jmp reserved
    38                          
    39                          init:
    40  c006 2024c7                 jsr copy_map_addrs
    41  c009 2057c7                 jsr copy_maps
    42  c00c 2091c8                 jsr compute_scan_xys
    43                          
    44                          redraw_init:
    45  c00f 2039c0                 jsr redraw_screen
    46                          
    47  c012 a000                   ldy #0
    48  c014 8c6ac9                 sty last_physline
    49  c017 8c6bc9                 sty last_logcol
    50  c01a 84d6                   sty physline
    51  c01c a90d                   lda #13
    52  c01e 20d2ff                 jsr chrout
    53  c021 c8                     iny
    54  c022 84d3                   sty logcol
    55                          
    56  c024 ad8602                 lda color    
    57  c027 290f                   and #15
    58  c029 8d6fc9                 sta fg_color
    59  c02c aa                     tax
    60  c02d bde7ca                 lda inverse_colors, x
    61  c030 8d70c9                 sta inv_color
    62  c033 20b6c8                 jsr color_the_codes
    63  c036 4c75c0                 jmp main_loop
    64                          
    65                          redraw_screen:
    66  c039 a900                   lda #0
    67  c03b 85d4                   sta quote
    68  c03d 85d8                   sta inserts
    69                          
    70  c03f a993                   lda #147
    71  c041 20d2ff                 jsr chrout
    72                              
    73  c044 a900                   lda #0
    74  c046 a201                   ldx #1
    75  c048 a001                   ldy #1
    76  c04a 2086c7                 jsr display_map
    77  c04d a901                   lda #1
    78  c04f a201                   ldx #1
    79  c051 a007                   ldy #7
    80  c053 2086c7                 jsr display_map
    81  c056 a902                   lda #2
    82  c058 a201                   ldx #1
    83  c05a a00d                   ldy #13
    84  c05c 2086c7                 jsr display_map
    85  c05f a903                   lda #3
    86  c061 a201                   ldx #1
    87  c063 a013                   ldy #19
    88  c065 2086c7                 jsr display_map
    89                          
    90  c068 a2a1                   ldx #<xystrings
    91  c06a a0c9                   ldy #>xystrings
    92  c06c 2046c8                 jsr display_xystrs
    93                          
    94  c06f a9ff                   lda #$ff
    95  c071 8d6cc9                 sta last_map
    96  c074 60                     rts
    97                          
    98                          main_loop:
    99  c075 2014c5             --  jsr check_cursor_moved
   100  c078 2002c7                 jsr blinkon
   101  c07b 20c9c6             -   jsr chkblink
   102  c07e 20e4ff                 jsr getkey
   103  c081 f0f8                   beq -
   104  c083 20f3c6                 jsr blinkoff
   105  c086 c911                   cmp #$11
   106  c088 d006                   bne +
   107  c08a 2056c4                 jsr cursor_down
   108  c08d 4c75c0                 jmp --
   109  c090 c991               +   cmp #$91
   110  c092 d006                   bne +
   111  c094 2085c4                 jsr cursor_up
   112  c097 4c75c0                 jmp --
   113  c09a c91d               +   cmp #$1d
   114  c09c d006                   bne +
   115  c09e 20b4c4                 jsr cursor_right
   116  c0a1 4c75c0                 jmp --
   117  c0a4 c99d               +   cmp #$9d
   118  c0a6 d006                   bne +
   119  c0a8 20c3c4                 jsr cursor_left
   120  c0ab 4c75c0                 jmp --
   121  c0ae c909               +   cmp #9 ; ^I
   122  c0b0 d006                   bne +
   123  c0b2 20d2c4                 jsr cursor_tab
   124  c0b5 4c75c0                 jmp --
   125  c0b8 c913               +   cmp #19 ; home
   126  c0ba d006                   bne +
   127  c0bc 20d2c4                 jsr cursor_tab
   128  c0bf 4c75c0                 jmp --
   129  c0c2 c985               +   cmp #133 ; F1
   130  c0c4 d006                   bne +
   131  c0c6 20e3c4                 jsr bg_color_inc
   132  c0c9 4c75c0                 jmp --
   133  c0cc c989               +   cmp #137 ; F2
   134  c0ce d006                   bne +
   135  c0d0 20f1c4                 jsr bg_color_dec
   136  c0d3 4c75c0                 jmp --
   137  c0d6 c986               +   cmp #134 ; F3
   138  c0d8 d006                   bne +
   139  c0da ee20d0                 inc border
   140  c0dd 4c75c0                 jmp --
   141  c0e0 c98a               +   cmp #138 ; F4
   142  c0e2 d006                   bne +
   143  c0e4 ce20d0                 dec border
   144  c0e7 4c75c0                 jmp --
   145  c0ea c988               +   cmp #136 ; F7
   146  c0ec d003                   bne +
   147  c0ee 4c38c1                 jmp save_map
   148  c0f1 c903               +   cmp #3 ; STOP
   149  c0f3 d003                   bne +
   150  c0f5 4cccc8                 jmp checkexit ; will not return directly
   151  c0f8 c90d               +   cmp #13
   152  c0fa d006                   bne +
   153  c0fc 20f1c1                 jsr pick_from_chart
   154  c0ff 4c75c0                 jmp --
   155  c102 c912               +   cmp #18 ; reverse on
   156  c104 d012                   bne +
   157  c106 ae21d0                 ldx background
   158  c109 ad6fc9                 lda fg_color
   159  c10c 8d21d0                 sta background
   160  c10f 8a                     txa
   161  c110 290f                   and #$F
   162  c112 8d8602                 sta color
   163  c115 4c0fc0                 jmp redraw_init
   164  c118 c992               +   cmp #146 ; reverse off
   165  c11a d012                   bne +
   166  c11c ae70c9                 ldx inv_color
   167  c11f ad6fc9                 lda fg_color
   168  c122 8d70c9                 sta inv_color
   169  c125 8a                     txa
   170  c126 290f                   and #$F
   171  c128 8d8602                 sta color
   172  c12b 4c0fc0                 jmp redraw_init
   173  c12e 20ffc4             +   jsr check_color
   174  c131 209fc1                 jsr edit_key
   175  c134 4c75c0                 jmp --
   176                          
   177                          reserved:
   178  c137 00                     brk
   179                          
   180                          save_map:
   181                              ; copy driver
   182  c138 a000                   ldy #0
   183  c13a a2e0                   ldx #driver_length
   184  c13c b93ecb             -   lda driver, y
   185  c13f 990008                 sta $800, y
   186  c142 c8                     iny
   187  c143 ca                     dex
   188  c144 d0f6                   bne -
   189                          
   190                              ; pad first page with zeros
   191  c146 8a                     txa
   192  c147 990008             -   sta $800, y
   193  c14a c8                     iny
   194  c14b d0fa                   bne -
   195                          
   196                              ; copy 65*4 = 260 bytes   
   197  c14d a9fc                   lda #<remaps_dest
   198  c14f 85fb                   sta $fb
   199  c151 a908                   lda #>remaps_dest
   200  c153 85fc                   sta $fc
   201  c155 b91ecc             -   lda remaps, y
   202  c158 91fb                   sta ($fb),y
   203  c15a c8                     iny
   204  c15b d0f8                   bne -
   205  c15d e6fc                   inc $fc
   206  c15f a204                   ldx #4
   207  c161 b91ecd             -   lda remaps+256, y
   208  c164 91fb                   sta ($fb),y
   209  c166 c8                     iny
   210  c167 ca                     dex
   211  c168 d0f7                   bne -
   212                          
   213                              ; pad the last page with zeros
   214  c16a 98                     tya
   215  c16b 18                     clc
   216  c16c 65fb                   adc $fb
   217  c16e f00e                   beq ++ ; nothing to pad
   218  c170 a8                     tay
   219  c171 a900                   lda #0
   220  c173 85fb                   sta $fb
   221  c175 9002                   bcc +
   222  c177 e6fc                   inc $fc
   223                          +
   224  c179 91fb               -   sta ($fb),y
   225  c17b c8                     iny
   226  c17c d0fb                   bne -
   227                              
   228  c17e a000               ++  ldy #0
   229  c180 b907cb             -   lda reset_basic, y
   230  c183 f006                   beq +
   231  c185 20d2ff                 jsr chrout
   232  c188 c8                     iny
   233  c189 d0f5                   bne -
   234                          +
   235  c18b a900                   lda #0
   236  c18d 85c6                   sta 198
   237  c18f a000                   ldy #0
   238  c191 b936cb             -   lda save_strokes, y
   239  c194 f008                   beq +
   240  c196 997702                 sta 631,y
   241  c199 c8                     iny
   242  c19a e6c6                   inc 198
   243  c19c d0f3                   bne -
   244                          
   245  c19e 60                 +   rts ; !!!EXIT!!!
   246                          
   247                          edit_key:
   248  c19f 8502                   sta $02
   249  c1a1 a6d3                   ldx logcol
   250  c1a3 a4d6                   ldy physline
   251  c1a5 209fc5                 jsr get_scancode_index
   252  c1a8 b9fbc8                 lda scan_layout, y
   253  c1ab c9ff                   cmp #$ff
   254  c1ad d004                   bne +
   255  c1af e6d3                   inc logcol
   256  c1b1 d033                   bne ++
   257  c1b3 a8                 +   tay
   258  c1b4 b922cd                 lda scancode_x, y
   259  c1b7 8503                   sta $03
   260  c1b9 b962cd                 lda scancode_y, y
   261  c1bc 8504                   sta $04
   262  c1be a502                   lda $02
   263  c1c0 91fb                   sta ($fb),y
   264  c1c2 a201                   ldx #1
   265  c1c4 8e69c9                 stx col_x
   266  c1c7 a4ff                   ldy $ff
   267  c1c9 b95dc9                 lda mult_x6,y
   268  c1cc a8                     tay
   269  c1cd c8                     iny
   270  c1ce 8c68c9                 sty row_y
   271  c1d1 a502                   lda $02
   272  c1d3 a603                   ldx $03
   273  c1d5 a404                   ldy $04
   274  c1d7 c9ff                   cmp #$ff
   275  c1d9 d008                   bne +
   276  c1db a920                   lda #32
   277  c1dd 20d2ff                 jsr chrout
   278  c1e0 4ce6c1                 jmp ++
   279  c1e3 20d9c7             +   jsr display_char_at_xy ; assumes drawing keyboard with origin set, that's why we moved the origin and x/y
   280  c1e6 a5d3               ++  lda logcol
   281  c1e8 c913                   cmp #19
   282  c1ea 9004                   bcc +
   283  c1ec a901                   lda #1
   284  c1ee 85d3                   sta logcol
   285  c1f0 60                 +   rts
   286                          
   287                          pick_from_chart:
   288  c1f1 a6d3                   ldx logcol
   289  c1f3 a4d6                   ldy physline
   290  c1f5 86a3                   stx $a3
   291  c1f7 84a4                   sty $a4
   292  c1f9 2026c2                 jsr display_chr_chart
   293  c1fc 08                     php
   294  c1fd 48                     pha
   295  c1fe 2039c0                 jsr redraw_screen
   296  c201 a900                   lda #0
   297  c203 8d69c9                 sta col_x
   298  c206 8d68c9                 sta row_y
   299  c209 a6a3                   ldx $a3
   300  c20b a4a4                   ldy $a4
   301  c20d 2028c8                 jsr locate_xy
   302  c210 68                     pla
   303  c211 28                     plp
   304  c212 9006                   bcc +
   305  c214 202cc5                 jsr display_codes
   306  c217 4c1dc2                 jmp ++
   307  c21a 209fc1             +   jsr edit_key
   308  c21d a900               ++  lda #0
   309  c21f 8d69c9                 sta col_x
   310  c222 8d68c9                 sta row_y
   311  c225 60                     rts
   312                          
   313                          display_chr_chart:
   314                              ; clear screen, fill with invisible (for now) reverse spaces
   315  c226 ad21d0                 lda background
   316  c229 290f                   and #$F
   317  c22b a200                   ldx #0
   318  c22d 9d00d8             -   sta $d800,x
   319  c230 9d00d9                 sta $d900,x
   320  c233 9d00da                 sta $da00,x
   321  c236 9d00db                 sta $db00,x
   322  c239 e8                     inx
   323  c23a d0f1                   bne -
   324  c23c ad8802                 lda screenpage
   325  c23f 85fc                   sta $fc
   326  c241 a9a0                   lda #$a0
   327  c243 a204                   ldx #4
   328  c245 a000                   ldy #0
   329  c247 84fb                   sty $fb
   330  c249 91fb               -   sta ($fb),y
   331  c24b c8                     iny
   332  c24c d0fb                   bne -
   333  c24e e6fc                   inc $fc
   334  c250 ca                     dex
   335  c251 d0f6                   bne -
   336                          
   337  c253 a295                   ldx #<xyfind
   338  c255 a0ca                   ldy #>xyfind
   339  c257 205bc8                 jsr display_xystr
   340  c25a a2a2                   ldx #<xyfind_done
   341  c25c a0ca                   ldy #>xyfind_done
   342  c25e 205bc8                 jsr display_xystr
   343  c261 a2a7                   ldx #<xystop
   344  c263 a0ca                   ldy #>xystop
   345  c265 205bc8                 jsr display_xystr
   346                          
   347  c268 a900                   lda #0
   348  c26a 85ff                   sta $ff
   349  c26c 85fb                   sta $fb
   350  c26e 85fc                   sta $fc
   351  c270 a90c                   lda #12
   352  c272 8d69c9                 sta col_x
   353  c275 a904                   lda #4
   354  c277 8d68c9                 sta row_y
   355                          
   356  c27a ad70c9                 lda inv_color
   357  c27d 8d8602                 sta color
   358  c280 a200                   ldx #0
   359  c282 a000                   ldy #0
   360  c284 2028c8                 jsr locate_xy
   361  c287 a930                   lda #'0'
   362  c289 20d2ff             -   jsr chrout
   363  c28c 18                     clc
   364  c28d 6901                   adc #1
   365  c28f c947                   cmp #'G'
   366  c291 f008                   beq +
   367  c293 c93a                   cmp #0x3A
   368  c295 d0f2                   bne -
   369  c297 a941                   lda #'A'
   370  c299 d0ee                   bne -
   371                          +   
   372  c29b ce69c9                 dec col_x
   373  c29e a930                   lda #'0'
   374  c2a0 85fd                   sta $fd
   375  c2a2 ee68c9             -   inc row_y
   376  c2a5 a200                   ldx #0
   377  c2a7 a000                   ldy #0
   378  c2a9 20d9c7                 jsr display_char_at_xy
   379  c2ac 18                     clc
   380  c2ad 6901                   adc #1
   381  c2af c947                   cmp #'G'
   382  c2b1 f008                   beq +
   383  c2b3 c93a                   cmp #0x3A
   384  c2b5 d0eb                   bne -
   385  c2b7 a941                   lda #'A'
   386  c2b9 d0e7                   bne -
   387  c2bb ee69c9             +   inc col_x
   388  c2be a905                   lda #5
   389  c2c0 8d68c9                 sta row_y
   390  c2c3 ad6fc9                 lda fg_color
   391  c2c6 8d8602                 sta color
   392                          
   393  c2c9 a5ff               -   lda $ff
   394  c2cb c920                   cmp #$20
   395  c2cd f004                   beq ++
   396  c2cf c9a0                   cmp #$a0
   397  c2d1 d006                   bne +
   398  c2d3 20d2ff             ++  jsr chrout
   399  c2d6 4ce0c2                 jmp ++
   400  c2d9 a6fb               +   ldx $fb
   401  c2db a4fc                   ldy $fc
   402  c2dd 20d9c7                 jsr display_char_at_xy
   403  c2e0 e6ff               ++  inc $ff
   404  c2e2 f010                   beq +
   405  c2e4 e6fb                   inc $fb
   406  c2e6 a5fb                   lda $fb
   407  c2e8 c910                   cmp #$10
   408  c2ea d0dd                   bne -
   409  c2ec a900                   lda #0
   410  c2ee 85fb                   sta $fb
   411  c2f0 e6fc                   inc $fc
   412  c2f2 d0d5                   bne -
   413                          
   414  c2f4 a200               +   ldx #0
   415  c2f6 a000                   ldy #0
   416  c2f8 2028c8                 jsr locate_xy
   417  c2fb 20dac3             --  jsr draw_target_on
   418  c2fe 2002c7                 jsr blinkon
   419  c301 20c9c6             -   jsr chkblink
   420  c304 20e4ff                 jsr getkey
   421  c307 f0f8                   beq -
   422  c309 20f3c6                 jsr blinkoff
   423  c30c 85ff                   sta $ff
   424  c30e 20e2c3                 jsr draw_target_off
   425  c311 a5ff                   lda $ff
   426  c313 c911                   cmp #$11 ; cursor down
   427  c315 d012                   bne +
   428  c317 38                     sec
   429  c318 a5d6                   lda physline
   430  c31a ed68c9                 sbc row_y
   431  c31d c90f                   cmp #$F
   432  c31f b0da                   bcs --
   433  c321 a911                   lda #$11
   434  c323 20d2ff                 jsr chrout
   435  c326 4cfbc2                 jmp --
   436  c329 c991               +   cmp #$91 ; cursor up
   437  c32b d012                   bne +
   438  c32d 38                     sec
   439  c32e a5d6                   lda physline
   440  c330 ed68c9                 sbc row_y
   441  c333 c901                   cmp #1
   442  c335 90c4                   bcc --
   443  c337 a991                   lda #$91
   444  c339 20d2ff                 jsr chrout
   445  c33c 4cfbc2                 jmp --
   446  c33f c91d               +   cmp #$1d
   447  c341 d012                   bne +
   448  c343 38                     sec
   449  c344 a5d3                   lda logcol
   450  c346 ed69c9                 sbc col_x
   451  c349 c90f                   cmp #15
   452  c34b b0ae                   bcs --
   453  c34d a91d                   lda #$1d
   454  c34f 20d2ff                 jsr chrout
   455  c352 4cfbc2                 jmp --
   456  c355 c99d               +   cmp #$9d
   457  c357 d012                   bne +
   458  c359 38                     sec
   459  c35a a5d3                   lda logcol
   460  c35c ed69c9                 sbc col_x
   461  c35f c901                   cmp #1
   462  c361 9098                   bcc --
   463  c363 a99d                   lda #$9d
   464  c365 20d2ff                 jsr chrout
   465  c368 4cfbc2                 jmp --
   466  c36b c986               +   cmp #134 ; F3 - find
   467  c36d d044                   bne +
   468  c36f ae69c9                 ldx col_x
   469  c372 ac68c9                 ldy row_y
   470  c375 86fd                   stx $fd
   471  c377 84fe                   sty $fe
   472  c379 a295                   ldx #<xyfind
   473  c37b a0ca                   ldy #>xyfind
   474  c37d 205bc8                 jsr display_xystr
   475  c380 2002c7                 jsr blinkon
   476  c383 20c9c6             -   jsr chkblink
   477  c386 20e4ff                 jsr getkey
   478  c389 f0f8                   beq -
   479  c38b 85ff                   sta $ff
   480  c38d 20f3c6                 jsr blinkoff
   481  c390 a2a2                   ldx #<xyfind_done
   482  c392 a0ca                   ldy #>xyfind_done
   483  c394 205bc8                 jsr display_xystr
   484  c397 a6fd                   ldx $fd
   485  c399 a4fe                   ldy $fe
   486  c39b 8e69c9                 stx col_x
   487  c39e 8c68c9                 sty row_y
   488  c3a1 a5ff                   lda $ff
   489  c3a3 4a                 --- lsr
   490  c3a4 4a                     lsr
   491  c3a5 4a                     lsr
   492  c3a6 4a                     lsr
   493  c3a7 a8                     tay
   494  c3a8 a5ff                   lda $ff
   495  c3aa 290f                   and #$F
   496  c3ac aa                     tax
   497  c3ad 2028c8                 jsr locate_xy
   498  c3b0 4cfbc2                 jmp --
   499  c3b3 c903               +   cmp #3 ; STOP
   500  c3b5 d004                   bne +
   501  c3b7 a9ff                   lda #$ff
   502  c3b9 38                     sec ; not okay
   503  c3ba 60                     rts
   504  c3bb c90d               +   cmp #13
   505  c3bd f005                   beq +
   506  c3bf 85ff                   sta $ff
   507  c3c1 4ca3c3                 jmp ---
   508  c3c4 38                 +   sec
   509  c3c5 a5d6                   lda physline
   510  c3c7 ed68c9                 sbc row_y
   511  c3ca 0a                     asl
   512  c3cb 0a                     asl
   513  c3cc 0a                     asl
   514  c3cd 0a                     asl
   515  c3ce 85ff                   sta $ff
   516  c3d0 38                     sec
   517  c3d1 a5d3                   lda logcol
   518  c3d3 ed69c9                 sbc col_x
   519  c3d6 05ff                   ora $ff
   520  c3d8 18                     clc ; OK
   521  c3d9 60                     rts
   522                          
   523                          draw_target_on
   524  c3da ad70c9                 lda inv_color
   525  c3dd 8502                   sta $02
   526  c3df 4ceac3                 jmp draw_target
   527                          
   528                          draw_target_off
   529  c3e2 ad21d0                 lda background
   530  c3e5 8502                   sta $02
   531  c3e7 4ceac3                 jmp draw_target
   532                          
   533                          draw_target:
   534  c3ea a000                   ldy #0
   535  c3ec 84fb                   sty $fb
   536  c3ee a9d8                   lda #$d8
   537  c3f0 85fc                   sta $fc
   538  c3f2 a6d6                   ldx physline
   539  c3f4 204ac4             -   jsr target_plus_40
   540  c3f7 ca                     dex
   541  c3f8 d0fa                   bne -
   542  c3fa ac69c9                 ldy col_x
   543  c3fd 88                     dey
   544  c3fe 88                     dey
   545  c3ff a502                   lda $02
   546  c401 91fb               -   sta ($fb),y
   547  c403 88                     dey
   548  c404 10fb                   bpl -
   549  c406 18                     clc
   550  c407 ad69c9                 lda col_x
   551  c40a 6910                   adc #16
   552  c40c a8                     tay
   553  c40d a502                   lda $02
   554  c40f 91fb               -   sta ($fb),y
   555  c411 c8                     iny
   556  c412 c028                   cpy #40
   557  c414 90f9                   bcc -
   558                          
   559  c416 a000                   ldy #0
   560  c418 84fb                   sty $fb
   561  c41a a9d8                   lda #$d8
   562  c41c 85fc                   sta $fc
   563  c41e ae68c9                 ldx row_y
   564  c421 ca                     dex
   565  c422 a4d3                   ldy logcol
   566  c424 a502               -   lda $02
   567  c426 91fb                   sta ($fb),y
   568  c428 204ac4                 jsr target_plus_40
   569  c42b ca                     dex
   570  c42c d0f6                   bne -
   571  c42e a211                   ldx #17
   572  c430 204ac4             -   jsr target_plus_40
   573  c433 ca                     dex
   574  c434 d0fa                   bne -
   575  c436 38                     sec
   576  c437 a919                   lda #25
   577  c439 ed68c9                 sbc row_y
   578  c43c e910                   sbc #16
   579  c43e aa                     tax
   580  c43f a502               -   lda $02
   581  c441 91fb                   sta ($fb),y
   582  c443 204ac4                 jsr target_plus_40
   583  c446 ca                     dex
   584  c447 d0f6                   bne -
   585                          
   586  c449 60                     rts
   587                          
   588                          target_plus_40:
   589  c44a 18                     clc
   590  c44b a5fb                   lda $fb
   591  c44d 6928                   adc #40
   592  c44f 85fb                   sta $fb
   593  c451 9002                   bcc +
   594  c453 e6fc                   inc $fc
   595  c455 60                 +   rts
   596                          
   597                          cursor_down:
   598  c456 a6d6                   ldx physline
   599  c458 e017                   cpx #23
   600  c45a 900e                   bcc +
   601  c45c a4d3                   ldy logcol
   602  c45e a200                   ldx #0
   603  c460 86d6                   stx physline
   604  c462 a90d                   lda #13
   605  c464 20d2ff                 jsr chrout
   606  c467 84d3                   sty logcol
   607  c469 60                     rts
   608  c46a 20d2ff             +   jsr chrout
   609  c46d a6d6                   ldx physline
   610  c46f e006                   cpx #6
   611  c471 d003                   bne +
   612  c473 20d2ff                 jsr chrout
   613  c476 e00c               +   cpx #12
   614  c478 d003                   bne +
   615  c47a 20d2ff                 jsr chrout
   616  c47d e012               +   cpx #18
   617  c47f d003                   bne +
   618  c481 20d2ff                 jsr chrout
   619  c484 60                 +   rts
   620                          
   621                          cursor_up:
   622  c485 a6d6                   ldx physline
   623  c487 e002                   cpx #2
   624  c489 b00e                   bcs +
   625  c48b a216                   ldx #22
   626  c48d 86d6                   stx physline
   627  c48f a4d3                   ldy logcol
   628  c491 a90d                   lda #13
   629  c493 20d2ff                 jsr chrout
   630  c496 84d3                   sty logcol
   631  c498 60                     rts
   632  c499 20d2ff             +   jsr chrout
   633  c49c a6d6                   ldx physline
   634  c49e e006                   cpx #6
   635  c4a0 d003                   bne +
   636  c4a2 20d2ff                 jsr chrout
   637  c4a5 e00c               +   cpx #12
   638  c4a7 d003                   bne +
   639  c4a9 20d2ff                 jsr chrout
   640  c4ac e012               +   cpx #18
   641  c4ae d003                   bne +
   642  c4b0 20d2ff                 jsr chrout
   643  c4b3 60                 +   rts
   644                          
   645                          cursor_right:
   646  c4b4 a6d3                   ldx logcol
   647  c4b6 e012                   cpx #18
   648  c4b8 9005                   bcc +
   649  c4ba a201                   ldx #1
   650  c4bc 86d3                   stx logcol
   651  c4be 60                     rts
   652  c4bf 20d2ff             +   jsr chrout
   653  c4c2 60                     rts
   654                          
   655                          cursor_left:
   656  c4c3 a6d3                   ldx logcol
   657  c4c5 e002                   cpx #2
   658  c4c7 b005                   bcs +
   659  c4c9 a212                   ldx #18
   660  c4cb 86d3                   stx logcol
   661  c4cd 60                     rts
   662  c4ce 20d2ff             +   jsr chrout
   663  c4d1 60                     rts
   664                          
   665                          cursor_tab:
   666  c4d2 18                     clc
   667  c4d3 a5d6                   lda physline
   668  c4d5 6906                   adc #6
   669  c4d7 c918                   cmp #24
   670  c4d9 9002                   bcc +
   671  c4db e918                   sbc #24
   672  c4dd a8                 +   tay
   673  c4de a6d3                   ldx logcol
   674  c4e0 4c28c8                 jmp locate_xy
   675                          
   676                          bg_color_inc:
   677  c4e3 ee21d0             -   inc background
   678  c4e6 ad21d0                 lda background
   679  c4e9 290f                   and #15
   680  c4eb cd6fc9                 cmp fg_color
   681  c4ee f0f3                   beq -
   682  c4f0 60                     rts
   683                          
   684                          bg_color_dec:
   685  c4f1 ce21d0             -   dec background
   686  c4f4 ad21d0                 lda background
   687  c4f7 290f                   and #15
   688  c4f9 cd6fc9                 cmp fg_color
   689  c4fc f0f3                   beq -
   690  c4fe 60                     rts
   691                          
   692                          check_color:
   693  c4ff a200                   ldx #0
   694  c501 ddd7ca             -   cmp color_chars, x
   695  c504 f006                   beq +
   696  c506 e8                     inx
   697  c507 e010                   cpx #16
   698  c509 d0f6                   bne -
   699  c50b 60                     rts
   700  c50c 8e8602             +   stx color
   701  c50f 68                     pla ; pull return address
   702  c510 68                     pla
   703  c511 4c0fc0                 jmp redraw_init ; restart program
   704                          
   705                          check_cursor_moved:
   706  c514 a6d3                   ldx logcol
   707  c516 a4d6                   ldy physline
   708  c518 cc6ac9                 cpy last_physline
   709  c51b d005                   bne +
   710  c51d ec6bc9                 cpx last_logcol
   711  c520 f009                   beq ++
   712  c522 8e6bc9             +   stx last_logcol
   713  c525 8c6ac9                 sty last_physline
   714  c528 202cc5                 jsr display_codes
   715  c52b 60                 ++  rts
   716                          
   717                          display_codes:
   718  c52c 209fc5                 jsr get_scancode_index
   719  c52f 20d9c5                 jsr check_redraw_frame
   720  c532 a946                   lda #70 ; offset of screen to display code at
   721  c534 85fd                   sta $fd
   722  c536 ad8802                 lda screenpage
   723  c539 85fe                   sta $fe
   724  c53b b9fbc8                 lda scan_layout,y
   725  c53e 8502                   sta $02
   726  c540 2070c6                 jsr display_hex
   727  c543 2090c6                 jsr display_decimal
   728  c546 a5fd                   lda $fd
   729  c548 18                     clc
   730  c549 6928                   adc #40
   731  c54b 85fd                   sta $fd
   732  c54d 9002                   bcc +
   733  c54f e6fe                   inc $fe
   734  c551 a402               +   ldy $02
   735  c553 a9ff                   lda #$ff
   736  c555 c040                   cpy #64
   737  c557 b002                   bcs +
   738  c559 b1fb                   lda ($fb),y
   739  c55b 8502               +   sta $02
   740  c55d 2070c6                 jsr display_hex
   741  c560 2090c6                 jsr display_decimal
   742  c563 a6ff                   ldx $ff
   743  c565 d006                   bne +
   744  c567 a271                   ldx #<state_none
   745  c569 a0c9                   ldy #>state_none
   746  c56b d019                   bne ++
   747  c56d ca                 +   dex
   748  c56e d006                   bne +
   749  c570 a27d                   ldx #<state_shift
   750  c572 a0c9                   ldy #>state_shift
   751  c574 d010                   bne ++
   752  c576 ca                 +   dex
   753  c577 d006                   bne +
   754  c579 a289                   ldx #<state_commodore
   755  c57b a0c9                   ldy #>state_commodore
   756  c57d d007                   bne ++
   757  c57f ca                 +   dex
   758  c580 d01c                   bne +++
   759  c582 a295                   ldx #<state_control
   760  c584 a0c9                   ldy #>state_control
   761  c586 ad70c9             ++  lda inv_color
   762  c589 8d8602                 sta color
   763  c58c 205bc8                 jsr display_xystr
   764  c58f ad6fc9                 lda fg_color
   765  c592 8d8602                 sta color
   766  c595 ae6bc9                 ldx last_logcol
   767  c598 ac6ac9                 ldy last_physline
   768  c59b 2028c8                 jsr locate_xy
   769  c59e 60                 +++ rts
   770                          
   771                          get_scancode_index: ; output: $ff=map, 
   772  c59f a900                   lda #0
   773  c5a1 85ff                   sta $ff ; map #
   774  c5a3 a91e                   lda #<remaps
   775  c5a5 85fb                   sta $fb
   776  c5a7 a9cc                   lda #>remaps
   777  c5a9 85fc                   sta $fc    
   778  c5ab c006               -   cpy #6
   779  c5ad 9013                   bcc +
   780  c5af e6ff                   inc $ff
   781  c5b1 98                     tya
   782  c5b2 e906                   sbc #6
   783  c5b4 a8                     tay
   784  c5b5 18                     clc
   785  c5b6 a5fb                   lda $fb
   786  c5b8 6941                   adc #65
   787  c5ba 85fb                   sta $fb
   788  c5bc 90ed                   bcc -
   789  c5be e6fc                   inc $fc
   790  c5c0 d0e9                   bne -
   791  c5c2 ca                 +   dex ; change col 1 to 0, etc.
   792  c5c3 8a                     txa
   793  c5c4 88                     dey ; change line 1 to 0, etc.
   794  c5c5 c004                   cpy #4
   795  c5c7 d00a                   bne +
   796  c5c9 c903                   cmp #3 ; spacebar starts at col 3
   797  c5cb 9006                   bcc +
   798  c5cd c90c                   cmp #12 ; spacebar ends at col 11
   799  c5cf b002                   bcs +
   800  c5d1 a903                   lda #3 ; spacebar is always at 3,4 (0 based)
   801  c5d3 18                 +   clc
   802  c5d4 7962c9                 adc mult_x18,y
   803  c5d7 a8                     tay
   804  c5d8 60                     rts
   805                          
   806                          check_redraw_frame:
   807  c5d9 48                     pha
   808  c5da 8a                     txa
   809  c5db 48                     pha
   810  c5dc 98                     tya
   811  c5dd 48                     pha
   812  c5de a5ff                   lda $ff
   813  c5e0 cd6cc9                 cmp last_map
   814  c5e3 f02d                   beq ++
   815  c5e5 18                     clc
   816  c5e6 6603                   ror $03 ; high bit clear = erase mode
   817  c5e8 ac6cc9                 ldy last_map
   818  c5eb c004                   cpy #4
   819  c5ed b003                   bcs + ; branch out of range
   820  c5ef 2018c6                 jsr draw_frame
   821  c5f2 38                 +   sec
   822  c5f3 6603                   ror $03 ; high bit set = draw mode
   823  c5f5 ad70c9                 lda inv_color
   824  c5f8 8d8602                 sta color
   825  c5fb a4ff                   ldy $ff
   826  c5fd 8c6cc9                 sty last_map
   827  c600 2018c6                 jsr draw_frame
   828  c603 ae6bc9                 ldx last_logcol
   829  c606 ac6ac9                 ldy last_physline
   830  c609 2028c8                 jsr locate_xy
   831  c60c ad6fc9                 lda fg_color
   832  c60f 8d8602                 sta color
   833  c612 68                 ++  pla
   834  c613 a8                     tay
   835  c614 68                     pla
   836  c615 aa                     tax
   837  c616 68                     pla
   838  c617 60                     rts
   839                          
   840                          draw_frame:
   841  c618 b95dc9                 lda mult_x6,y
   842  c61b a8                     tay
   843  c61c 2030c6                 jsr draw_frame_line
   844  c61f c8                     iny
   845  c620 a905                   lda #5
   846  c622 8502                   sta $02
   847  c624 2049c6             -   jsr draw_frame_sides
   848  c627 c8                     iny
   849  c628 c602                   dec $02
   850  c62a d0f8                   bne -
   851  c62c 2030c6                 jsr draw_frame_line
   852  c62f 60                     rts
   853                          
   854                          draw_frame_line:
   855  c630 a200                   ldx #0
   856  c632 2028c8                 jsr locate_xy
   857  c635 2403                   bit $03
   858  c637 1005                   bpl +
   859  c639 a912                   lda #18 ; reverse
   860  c63b 20d2ff                 jsr chrout
   861  c63e a214               +   ldx #20
   862  c640 a920                   lda #32
   863  c642 20d2ff             -   jsr chrout
   864  c645 ca                     dex
   865  c646 d0fa                   bne -
   866  c648 60                     rts
   867                          
   868                          draw_frame_sides:
   869  c649 a200                   ldx #0
   870  c64b 2028c8                 jsr locate_xy
   871  c64e 2403                   bit $03
   872  c650 1005                   bpl +
   873  c652 a912                   lda #18 ; reverse
   874  c654 20d2ff                 jsr chrout
   875  c657 a920               +   lda #32
   876  c659 20d2ff                 jsr chrout
   877  c65c a213                   ldx #19
   878  c65e 2028c8                 jsr locate_xy
   879  c661 2403                   bit $03
   880  c663 1005                   bpl +
   881  c665 a912                   lda #18 ; reverse
   882  c667 20d2ff                 jsr chrout
   883  c66a a920               +   lda #32
   884  c66c 20d2ff                 jsr chrout
   885  c66f 60                     rts
   886                          
   887                          display_hex: ; .A=value, $fd/fe screen dest
   888  c670 a8                     tay
   889  c671 290f                   and #$f
   890  c673 aa                     tax
   891  c674 bdf7ca                 lda hexcodes, x
   892  c677 aa                     tax
   893  c678 98                     tya
   894  c679 4a                     lsr
   895  c67a 4a                     lsr
   896  c67b 4a                     lsr
   897  c67c 4a                     lsr
   898  c67d a8                     tay
   899  c67e b9f7ca                 lda hexcodes, y
   900  c681 a001                   ldy #1
   901  c683 91fd                   sta ($fd),y
   902  c685 c8                     iny
   903  c686 8a                     txa
   904  c687 91fd                   sta ($fd),y
   905  c689 a000                   ldy #0
   906  c68b a924                   lda #'$'
   907  c68d 91fd                   sta ($fd),y
   908  c68f 60                     rts
   909                          
   910                          display_decimal: ; .A=value (and $02), $fd/fe screen dest (note: display to side of hex)
   911  c690 a004                   ldy #4
   912  c692 a92b                   lda #'+'
   913  c694 91fd                   sta ($fd),y
   914  c696 a502                   lda $02
   915  c698 8503                   sta $03
   916  c69a a200                   ldx #0
   917  c69c 38                     sec
   918  c69d e964               -   sbc #100
   919  c69f 9005                   bcc +
   920  c6a1 8503                   sta $03
   921  c6a3 e8                     inx
   922  c6a4 d0f7                   bne -
   923  c6a6 bdf7ca             +   lda hexcodes,x
   924  c6a9 c8                     iny
   925  c6aa 91fd                   sta ($fd),y
   926  c6ac a503                   lda $03
   927  c6ae a200                   ldx #0
   928  c6b0 38                     sec
   929  c6b1 e90a               -   sbc #10
   930  c6b3 9005                   bcc +
   931  c6b5 8503                   sta $03
   932  c6b7 e8                     inx
   933  c6b8 d0f7                   bne -
   934  c6ba bdf7ca             +   lda hexcodes,x
   935  c6bd c8                     iny
   936  c6be 91fd                   sta ($fd),y
   937  c6c0 a603                   ldx $03
   938  c6c2 bdf7ca                 lda hexcodes,x
   939  c6c5 c8                     iny
   940  c6c6 91fd                   sta ($fd),y
   941  c6c8 60                     rts
   942                          
   943                          chkblink:
   944  c6c9 38                     sec
   945  c6ca ad6dc9                 lda jiffyblink
   946  c6cd c5a2                   cmp jiffyclock
   947  c6cf d021                   bne ++
   948  c6d1 a5a2                   lda jiffyclock
   949  c6d3 6914                   adc #20
   950  c6d5 8d6dc9                 sta jiffyblink
   951  c6d8 ae70c9                 ldx inv_color
   952  c6db a4d3                   ldy logcol
   953  c6dd b1f3                   lda (colorptr),y
   954  c6df 290f                   and #15
   955  c6e1 cd6fc9                 cmp fg_color
   956  c6e4 f003                   beq +
   957  c6e6 ae6fc9                 ldx fg_color
   958  c6e9 8a                 +   txa
   959  c6ea 91f3                   sta (colorptr),y
   960  c6ec b1d1               +   lda (textptr),y
   961  c6ee 4980                   eor #$80
   962  c6f0 91d1                   sta (textptr),y
   963  c6f2 60                 ++  rts
   964                          
   965                          blinkoff:
   966  c6f3 aa                     tax
   967  c6f4 a4d3                   ldy logcol
   968  c6f6 ad6fc9                 lda fg_color
   969  c6f9 91f3                   sta (colorptr),y
   970  c6fb ad6ec9                 lda save_cursor_char
   971  c6fe 91d1                   sta (textptr),y
   972  c700 8a                     txa
   973  c701 60                     rts
   974                          
   975                          blinkon:
   976  c702 ae70c9                 ldx inv_color ; assume inverse color
   977  c705 a4d3                   ldy logcol
   978  c707 b1d1                   lda (textptr),y
   979  c709 8d6ec9                 sta save_cursor_char
   980  c70c 0980                   ora #$80 ; my cursor starts with reverse character, blinking can toggle
   981  c70e 91d1                   sta (textptr),y
   982  c710 3003                   bmi + ; yes inverse color
   983  c712 ae6fc9                 ldx fg_color ; no regular color
   984  c715 8a                 +   txa
   985  c716 91f3                   sta (colorptr),y
   986  c718 18                     clc
   987  c719 a5a2                   lda jiffyclock
   988  c71b 6914                   adc #20
   989  c71d 8d6dc9                 sta jiffyblink
   990  c720 60                     rts
   991                          
   992                          getmap:
   993  c721 6c8f02                 jmp ($028f)
   994                          
   995                          copy_map_addrs:
   996                              ; first retrieve addresses to four sets
   997  c724 78                     sei ; don't allow IRQ to process keyboard and interfere with us
   998                          
   999  c725 ad8d02                 lda shiftstate
  1000  c728 48                     pha ; save existing keyboard shift state
  1001                          
  1002  c729 a000                   ldy #0
  1003  c72b 84ff                   sty $ff
  1004  c72d 8c8d02                 sty shiftstate ; keyboard shift state (0,1,2,4)
  1005  c730 2021c7             -   jsr getmap
  1006  c733 a5f5                   lda $f5
  1007  c735 a4ff                   ldy $ff
  1008  c737 9955c9                 sta rom_maps,y
  1009  c73a a5f6                   lda $f6
  1010  c73c 9956c9                 sta rom_maps+1,y
  1011  c73f e6ff                   inc $ff
  1012  c741 e6ff                   inc $ff
  1013  c743 ad8d02                 lda shiftstate
  1014  c746 18                     clc
  1015  c747 d001                   bne +
  1016  c749 38                     sec
  1017  c74a 2e8d02             +   rol shiftstate
  1018  c74d c904                   cmp #4
  1019  c74f 90df                   bcc -
  1020                          
  1021  c751 68                     pla
  1022  c752 8d8d02                 sta shiftstate ; restore shift map
  1023                          
  1024  c755 58                     cli ; restore keyboard
  1025  c756 60                     rts
  1026                          
  1027                          copy_maps:
  1028  c757 a200                   ldx #0
  1029  c759 a91e                   lda #<remaps
  1030  c75b 85fd                   sta $fd
  1031  c75d a9cc                   lda #>remaps
  1032  c75f 85fe                   sta $fe
  1033  c761 bd55c9             --  lda rom_maps,x
  1034  c764 85fb                   sta $fb
  1035  c766 bd56c9                 lda rom_maps+1,x
  1036  c769 85fc                   sta $fc
  1037                          
  1038  c76b a040                   ldy #64
  1039  c76d b1fb               -   lda ($fb),y
  1040  c76f 91fd                   sta ($fd),y
  1041  c771 88                     dey
  1042  c772 10f9                   bpl -
  1043                          
  1044  c774 18                     clc
  1045  c775 a5fd                   lda $fd
  1046  c777 6941                   adc #65
  1047  c779 85fd                   sta $fd
  1048  c77b 9002                   bcc +
  1049  c77d e6fe                   inc $fe
  1050                          +
  1051  c77f e8                     inx
  1052  c780 e8                     inx
  1053  c781 e008                   cpx #8
  1054  c783 90dc                   bcc --
  1055  c785 60                     rts
  1056                          
  1057                          display_map: ; .a = map (0..3), .x/.y = screen coordinates
  1058  c786 8e69c9                 stx col_x
  1059  c789 8c68c9                 sty row_y
  1060                          
  1061  c78c aa                     tax
  1062  c78d a91e                   lda #<remaps
  1063  c78f 85fb                   sta $fb
  1064  c791 a9cc                   lda #>remaps
  1065  c793 85fc                   sta $fc
  1066  c795 e000                   cpx #0
  1067  c797 f00e                   beq ++
  1068  c799 18                 -   clc
  1069  c79a a5fb                   lda $fb
  1070  c79c 6941                   adc #65
  1071  c79e 85fb                   sta $fb
  1072  c7a0 9002                   bcc +
  1073  c7a2 e6fc                   inc $fc
  1074  c7a4 ca                 +   dex
  1075  c7a5 d0f2                   bne -
  1076                          ++
  1077  c7a7 a900                   lda #0
  1078  c7a9 85ff                   sta $ff ; scancode
  1079  c7ab a8                     tay
  1080  c7ac b1fb               -   lda ($fb),y ; remap of requested shift state
  1081  c7ae c9ff                   cmp #$ff
  1082  c7b0 f00f                   beq +
  1083                          
  1084  c7b2 8502                   sta $02 ; save character
  1085  c7b4 b922cd                 lda scancode_x, y
  1086  c7b7 aa                     tax
  1087  c7b8 b962cd                 lda scancode_y, y
  1088  c7bb a8                     tay
  1089  c7bc a502                   lda $02 ; restore character
  1090                          
  1091  c7be 20d9c7                 jsr display_char_at_xy
  1092  c7c1 e6ff               +   inc $ff
  1093  c7c3 a4ff                   ldy $ff
  1094  c7c5 c040                   cpy #64
  1095  c7c7 90e3                   bcc -
  1096  c7c9 60                     rts
  1097                          
  1098                          display_char:
  1099  c7ca 48                     pha
  1100  c7cb 38                     sec
  1101  c7cc a5d6                   lda physline
  1102  c7ce ed68c9                 sbc row_y
  1103  c7d1 a8                     tay
  1104  c7d2 a5d3                   lda logcol
  1105  c7d4 ed69c9                 sbc col_x
  1106  c7d7 aa                     tax
  1107  c7d8 68                     pla
  1108                              ; fall through display_char_at_xy
  1109                          
  1110                          display_char_at_xy:
  1111  c7d9 48                     pha
  1112  c7da a900                   lda #0
  1113  c7dc 85fe                   sta $fe
  1114  c7de c004                   cpy #4 ; spacebar row?
  1115  c7e0 d006                   bne +
  1116  c7e2 e003                   cpx #3 ; spacebar col?
  1117  c7e4 d002                   bne +
  1118  c7e6 a908                   lda #8 ; repeat count for spacebar position
  1119  c7e8 85fe               +   sta $fe
  1120                          
  1121  c7ea 2028c8                 jsr locate_xy
  1122                          
  1123  c7ed 68                     pla
  1124  c7ee c9a0                   cmp #160 ; shift space
  1125  c7f0 f002                   beq +
  1126  c7f2 c920                   cmp #32 ; space
  1127  c7f4 d006               +   bne +
  1128  c7f6 a201                   ldx #1
  1129  c7f8 86c7                   stx reverse
  1130  c7fa d01e                   bne ++
  1131  c7fc c90d               +   cmp #13 ; return ^M
  1132  c7fe d008                   bne +
  1133  c800 a201                   ldx #1
  1134  c802 86c7                   stx reverse
  1135  c804 a94d                   lda #'M'
  1136  c806 d012                   bne ++
  1137  c808 c98d               +   cmp #141 ; shift+return ^M
  1138  c80a d008                   bne +
  1139  c80c a201                   ldx #1
  1140  c80e 86c7                   stx reverse
  1141  c810 a96d                   lda #'m'
  1142  c812 d006                   bne ++
  1143  c814 a201               +   ldx #1
  1144  c816 86d4                   stx quote ; quote mode just in case for control characters
  1145  c818 86d8                   stx inserts ; number of inserts just in case for control characters
  1146                          ++
  1147  c81a 20d2ff             -   jsr chrout
  1148  c81d a200               +   ldx #0
  1149  c81f 86d4                   stx quote ; reset quote mode
  1150  c821 86d8                   stx inserts ; reset inserts
  1151  c823 c6fe                   dec $fe
  1152  c825 10f3                   bpl - ; repeat for spacebar
  1153  c827 60                     rts
  1154                          
  1155                          locate_xy:
  1156  c828 98                     tya
  1157  c829 18                     clc
  1158  c82a 6d68c9                 adc row_y
  1159  c82d c900                   cmp #0
  1160  c82f d004                   bne +
  1161  c831 a913                   lda #19 ; home
  1162  c833 d006                   bne ++
  1163  c835 e901               +   sbc #1
  1164  c837 85d6                   sta physline
  1165  c839 a90d                   lda #13
  1166  c83b 20d2ff             ++  jsr chrout ; effect the change
  1167  c83e 18                     clc
  1168  c83f 8a                     txa
  1169  c840 6d69c9                 adc col_x
  1170  c843 85d3                   sta logcol
  1171  c845 60                     rts
  1172                          
  1173                          display_xystrs: ; pointer to an xystr, terminated by empty string (0 length)
  1174  c846 86fb                   stx $fb
  1175  c848 84fc                   sty $fc
  1176  c84a a002               -   ldy #2
  1177  c84c b1fb                   lda ($fb),y
  1178  c84e f00a                   beq +
  1179  c850 a6fb                   ldx $fb
  1180  c852 a4fc                   ldy $fc
  1181  c854 205bc8                 jsr display_xystr
  1182  c857 4c4ac8                 jmp -
  1183  c85a 60                 +   rts
  1184                          
  1185                          display_xystr: ; string (x/y registers ptr) is prefixed by screen coordinates, terminated by null
  1186  c85b 86fb                   stx $fb
  1187  c85d 84fc                   sty $fc
  1188  c85f a000                   ldy #0
  1189  c861 8c69c9                 sty col_x
  1190  c864 8c68c9                 sty row_y
  1191  c867 b1fb                   lda ($fb),y
  1192  c869 aa                     tax
  1193  c86a c8                     iny
  1194  c86b b1fb                   lda ($fb),y
  1195  c86d a8                     tay
  1196  c86e 2028c8                 jsr locate_xy
  1197  c871 18                     clc
  1198  c872 a5fb                   lda $fb
  1199  c874 6902                   adc #2
  1200  c876 85fb                   sta $fb
  1201  c878 9002                   bcc +
  1202  c87a e6fc                   inc $fc
  1203  c87c a000               +   ldy #0
  1204  c87e b1fb               -   lda ($fb),y
  1205  c880 e6fb                   inc $fb
  1206  c882 d002                   bne +
  1207  c884 e6fc                   inc $fc
  1208  c886 c900               +   cmp #0
  1209  c888 f006                   beq +
  1210  c88a 20d2ff                 jsr chrout
  1211  c88d 4c7ec8                 jmp -
  1212  c890 60                 +   rts
  1213                          
  1214                          compute_scan_xys:
  1215  c891 a959                   lda #(5*18-1)
  1216  c893 85ff                   sta $ff
  1217  c895 a004                   ldy #4
  1218  c897 8402                   sty $02
  1219  c899 a211               --  ldx #17
  1220  c89b a4ff               -   ldy $ff
  1221  c89d b9fbc8                 lda scan_layout,y
  1222  c8a0 300a                   bmi +
  1223  c8a2 a8                     tay
  1224  c8a3 8a                     txa
  1225  c8a4 9922cd                 sta scancode_x,y
  1226  c8a7 a502                   lda $02
  1227  c8a9 9962cd                 sta scancode_y,y
  1228  c8ac c6ff               +   dec $ff
  1229  c8ae ca                     dex
  1230  c8af 10ea                   bpl -
  1231  c8b1 c602                   dec $02
  1232  c8b3 10e4                   bpl --
  1233  c8b5 60                     rts
  1234                          
  1235                          color_the_codes:
  1236  c8b6 a900                   lda #0
  1237  c8b8 85fb                   sta $fb
  1238  c8ba a9d8                   lda #$d8
  1239  c8bc 85fc                   sta $fc
  1240  c8be ad70c9                 lda inv_color
  1241  c8c1 a03d                   ldy #61
  1242  c8c3 a211                   ldx #17
  1243  c8c5 91fb               -   sta ($fb),y
  1244  c8c7 c8                     iny
  1245  c8c8 ca                     dex
  1246  c8c9 d0fa                   bne -
  1247  c8cb 60                     rts
  1248                          
  1249                          checkexit:
  1250  c8cc 20e1c8                 jsr areyousure
  1251  c8cf f003                   beq +
  1252  c8d1 4c0fc0                 jmp redraw_init
  1253                          +
  1254  c8d4 a5c5               -   lda 197
  1255  c8d6 c940                   cmp #64
  1256  c8d8 d0fa                   bne - ; wait until key released (avoids STOP BREAK)
  1257  c8da a2cf                   ldx #<xybye
  1258  c8dc a0ca                   ldy #>xybye
  1259  c8de 4c5bc8                 jmp display_xystr ; and !!!EXIT!!!
  1260                          
  1261                          areyousure:
  1262  c8e1 a900                   lda #0
  1263  c8e3 85d4                   sta quote
  1264  c8e5 85d8                   sta inserts
  1265  c8e7 a993                   lda #147
  1266  c8e9 20d2ff                 jsr chrout
  1267  c8ec a2b5                   ldx #<xyareyousure
  1268  c8ee a0ca                   ldy #>xyareyousure
  1269  c8f0 205bc8                 jsr display_xystr
  1270  c8f3 20e4ff             -   jsr getkey
  1271  c8f6 f0fb                   beq -
  1272  c8f8 c959                   cmp #'Y'
  1273  c8fa 60                     rts
  1274                          
  1275                          ; this is the hardware scan code physical layout as a 5x18 array
  1276                          ; keys are independent of internationalization, localization
  1277                          ; because these are scancodes - the physical key representations
  1278                          ; independent of the PETSCII codes they map to via KERNAL ROM
  1279                          ; or remapping like we will do
  1280                          ;
  1281                          ; each key 0..63 should be shown exactly once, with 255 for whitespace (not a key)
  1282                          ;
  1283                          ; the purpose of this array is to show where physical keys are
  1284                          ; It does not change.  !!! DO NOT CHANGE EXCEPT FOR COSMETIC REASONS !!!
  1285                          scan_layout: ; 5 rows, 18 columns = 90 bytes !!! CODE DEPENDS ON THESE DIMENSIONS !!!
  1286  c8fb 39383b080b101318...    !byte 57,56,59,8,11,16,19,24,27,32,35,40,43,48,51,0,255,4
  1287  c90d 3aff3e090e111619...    !byte 58,255,62,9,14,17,22,25,30,33,38,41,46,49,54,255,255,5
  1288  c91f 3fff0a0d12151a1d...    !byte 63,255,10,13,18,21,26,29,34,37,42,45,50,53,255,1,255,6
  1289  c931 3d340c17141f1c27...    !byte 61,52,12,23,20,31,28,39,36,47,44,55,255,15,7,2,255,3
  1290  c943 ffffff3cffffffff...    !byte 255,255,255,60,255,255,255,255,255,255,255,255,255,255,255,255,255,255
  1291                          
  1292                          ; with a US ROM, this will display like the following
  1293                          ; _1234567890+-\st E
  1294                          ; d qwertyuiop@*^  F
  1295                          ; c asdfghjkl:;= m G
  1296                          ; bazxcvbnm,./ aq] H
  1297                          
  1298                          rom_maps: ; addresses of maps in ROM
  1299  c955 0000                   !word 0 ; unshifted
  1300  c957 0000                   !word 0 ; shifted
  1301  c959 0000                   !word 0 ; commodore
  1302  c95b 0000                   !word 0 ; control
  1303                          
  1304                          mult_x6:
  1305  c95d 00060c1218             !byte 0, 6, 12, 18, 24
  1306                          
  1307                          mult_x18:
  1308  c962 00122436485a           !byte 0, 18, 36, 54, 72, 90
  1309                          
  1310                          ; origin point for locate_xy
  1311  c968 00                 row_y: !byte 0
  1312  c969 00                 col_x: !byte 0
  1313                          
  1314  c96a 00                 last_physline: !byte 0
  1315  c96b 00                 last_logcol: !byte 0
  1316  c96c 00                 last_map: !byte 0
  1317                          
  1318  c96d 00                 jiffyblink: !byte 0
  1319  c96e 00                 save_cursor_char: !byte 0
  1320  c96f 0e                 fg_color: !byte 14
  1321  c970 0b                 inv_color: !byte 11
  1322                          
  1323  c971 190420204e4f4e45...state_none:      !text 25,4,"  NONE   ",0
  1324  c97d 1904202053484946...state_shift:     !text 25,4,"  SHIFT  ",0
  1325  c989 1904434f4d4d4f44...state_commodore: !text 25,4,"COMMODORE",0
  1326  c995 190420434f4e5452...state_control:   !text 25,4," CONTROL ",0
  1327                          
  1328                          xystrings:
  1329  c9a1 15015343414e434f...    !text 21,1,"SCANCODE","          ",0
  1330  c9b6 1602504554534349...    !text 22,2,"PETSCII","          ",0
  1331                          ;
  1332  c9ca 17074e4156494741...    !text 23,7,"NAVIGATION:",0
  1333                          
  1334  c9d8 1709435552534f52...    !text 23,9,"CURSOR, HOME,",0
  1335  c9e8 170a434f4c4f5253...    !text 23,10,"COLORS, RVS,",0
  1336  c9f7 170b52455455524e...    !text 23,11,"RETURN, STOP", 0
  1337                          ;
  1338  ca06 170d463120424143...    !text 23,13,"F1 BACKGROUND+",0
  1339  ca17 170e463220424143...    !text 23,14,"F2 BACKGROUND-",0
  1340  ca28 170f463320424f52...    !text 23,15,"F3 BORDER+",0
  1341  ca35 1710463420424f52...    !text 23,16,"F4 BORDER-",0
  1342  ca42 1711463720534156...    !text 23,17,"F7 SAVE",0
  1343                          ;
  1344  ca4c 1715124b45594d41...    !text 23,21,18,"KEYMAP EDITOR",0
  1345  ca5d 1616284329323032...    !text 22,22,"(C)2025 DAVERVW",0
  1346  ca6f 18174d4954204c49...    !text 24,23,"MIT LICENSE",0
  1347  ca7d 1518474954485542...    !text 21,24,"GITHUB.COM/DAVERVW",0
  1348  ca92 000000                 !text 0,0,0
  1349                          
  1350  ca95 0101463320202046...xyfind:      !text 1,1,"F3   FIND:",0
  1351  caa2 0a01202000         xyfind_done: !text 10,1,"  ",0
  1352  caa7 010253544f502043...xystop:      !text 1,2,"STOP CANCEL",0
  1353                          
  1354  cab5 0a0c124152452059...xyareyousure !text 10,12,18,"ARE YOU SURE?",146," (Y/[N])",0
  1355  cacf 0000934259450d00   xybye !text 0,0,147,"BYE",13,0
  1356                          
  1357                          ; control characters that change colors, in order colors 0..15
  1358  cad7 90051c9f9c1e1f9e...color_chars !byte 144,5,28,159,156,30,31,158,129,149,150,151,152,153,154,155
  1359                          
  1360                          ; complementary colors in relation to colors 0..15
  1361  cae7 0100050a0d020809...inverse_colors !byte 1,0,5,10,13,2,8,9,6,7,3,14,15,4,11,12
  1362                          
  1363  caf7 3031323334353637...hexcodes !text "0123456789",1,2,3,4,5,6 ; screen codes
  1364                          
  1365  cb07 93504f4b4534332c...reset_basic !text 147,"POKE43,1:POKE44,8:POKE45,0:POKE46,10:CLR:LIST",0
  1366  cb36 130d534156452200   save_strokes !text 19,13,"SAVE",34,0
  1367                          
  1368                          driver: ; keyboard driver BASIC and assembler code targeting $0801
  1369  cb3e 0020080a008f204b...!byte $00,$20,$08,$0a,$00,$8f,$20,$4b,$45,$59,$42,$4f,$41,$52,$44,$20
  1370  cb4e 52454d4150504552...!byte $52,$45,$4d,$41,$50,$50,$45,$52,$20,$44,$52,$49,$56,$45,$52,$00
  1371  cb5e 420814008f203230...!byte $42,$08,$14,$00,$8f,$20,$32,$30,$32,$35,$20,$42,$59,$20,$44,$41
  1372  cb6e 56494420522e2056...!byte $56,$49,$44,$20,$52,$2e,$20,$56,$41,$4e,$20,$57,$41,$47,$4e,$45
  1373  cb7e 520056081e008f20...!byte $52,$00,$56,$08,$1e,$00,$8f,$20,$50,$55,$42,$4c,$49,$43,$20,$44
  1374  cb8e 4f4d41494e006308...!byte $4f,$4d,$41,$49,$4e,$00,$63,$08,$28,$00,$9e,$20,$32,$31,$35,$31
  1375  cb9e 3aa20000000000a9...!byte $3a,$a2,$00,$00,$00,$00,$00,$a9,$42,$a2,$06,$a0,$08,$20,$92,$08
  1376  cbae a225a008209208a9...!byte $a2,$25,$a0,$08,$20,$92,$08,$a9,$0a,$85,$2c,$a9,$00,$8d,$00,$0a
  1377  cbbe a247a008209208a2...!byte $a2,$47,$a0,$08,$20,$92,$08,$a2,$a7,$a0,$08,$8e,$8f,$02,$8c,$90
  1378  cbce 026086fb84fca000...!byte $02,$60,$86,$fb,$84,$fc,$a0,$00,$b1,$fb,$f0,$06,$20,$d2,$ff,$c8
  1379  cbde d0f6a90d4cd2ffa2...!byte $d0,$f6,$a9,$0d,$4c,$d2,$ff,$a2,$00,$ad,$8d,$02,$29,$07,$f0,$04
  1380  cbee e84ad0fce002d009...!byte $e8,$4a,$d0,$fc,$e0,$02,$d0,$09,$a5,$cb,$c9,$40,$d0,$03,$4c,$48
  1381  cbfe eba9fca008e000f0...!byte $eb,$a9,$fc,$a0,$08,$e0,$00,$f0,$09,$18,$69,$41,$90,$01,$c8,$ca
  1382  cc0e d0f785f584f64ce0...!byte $d0,$f7,$85,$f5,$84,$f6,$4c,$e0,$ea,$00,$00,$00,$00,$00,$00,$00
  1383                          driver_length = * - driver
  1384                          
  1385                          remaps = * ; 4 keyboard sets of PETSCII characters indexed by scancode (260 bytes total, 65 bytes each set)
  1386                          
  1387                          ; coordinates are derived from scan_layout at runtime to avoid redundant maintainance
  1388                          scancode_x = remaps + 260 ; 64 bytes total
  1389                          scancode_y = scancode_x + 64 ; 64 bytes total
  1390                          
  1391                          finish = scancode_y + 64 ; end
